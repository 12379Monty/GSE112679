---
title: "Read Data for NCBI GEO Series GSE112679"
author: "Francois.collin@gmail.com"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
  html_document:
    code_folding: show
    toc: true
    # does this have an effect
    fig_caption: yes
    # this has no effect
    number_sections: yes
    css: ../docs/_pandocFiles/github-markdown.css
    #css: ../docs/_pandocFiles/pandoc3.css
bibliography: ../docs/_bibFiles/bibFile.bib
csl: ../docs/_bibFiles/cell-numeric.csl
#biblio-style: acm
link-citations: true
vignette: >
 %\VignetteEncoding{UTF-8}
 %\VignetteEngine{knitr::rmarkdown}
---


```{r GlobalOptions, results="hide", include=FALSE, cache=FALSE}
knitr::opts_knit$set(stop_on_error = 2L) #really make it stop
#knitr::dep_auto()
```
<!-- ######################################################################## -->


```{r Prelims, include=FALSE, echo=FALSE, results='hide', message=FALSE,cache=F}

 FN <- "rdGSEData"
if(sum(grepl(FN, list.files()))==0) stop("Check FN")

 PREFIX <- ""

 suppressPackageStartupMessages(require(methods))
 suppressPackageStartupMessages(require(rmarkdown))
 suppressPackageStartupMessages(require(bookdown))

 suppressPackageStartupMessages(require(knitr))
 options(stringsAsFactors=F)

 suppressPackageStartupMessages(require(data.table)) 
 options(datatable.fread.datatable=F)

 suppressPackageStartupMessages(require(plyr))
 suppressPackageStartupMessages(require(dplyr))
 suppressPackageStartupMessages(require(magrittr))

 # Shotcuts for knitting and redering while in R session (Invoke interactive R from R/Scripts folder)
 kk <- function(n='') knitr::knit2html(paste("t", n, sep=''), envir=globalenv(),
       output=paste(FN,".html", sep=''))

 rr <- function(n='') rmarkdown::render(paste("t", n, sep=''), envir=globalenv(),
       output_file=paste(FN,".html", sep='')) ##, output_dir='Scripts')

 bb <- function(n='') browseURL(paste(FN,".html", sep=''))

 # The usual shotcuts
 zz <- function(n='') source(paste("t", n, sep=''))

 # Using relative paths:
 # Assuming script is run from GSE112679/data-raw/
 WRKDIR <- ('..')

 # Not needed if path is relative ...
 if(!file.exists(WRKDIR)) stop("WRKDIR ERROR: ", WRKDIR)

 # do once
 #setwd(WRKDIR)

 # file rmarkdown file management options: cache, figures
 cache_DIR <- file.path('cache/rdGEData/')
 suppressPackageStartupMessages(dir.create(cache_DIR, recursive=T))
 opts_chunk$set(cache.path=cache_DIR)

 figure_DIR <- file.path('figures/rdGEData/')
 suppressPackageStartupMessages(dir.create(figure_DIR, recursive=T))
 opts_chunk$set(fig.path=paste0(figure_DIR, PREFIX))

 data_DIR <- '../data'
 if(!file.exists(data_DIR)) stop("data_DIR ERROR: ", data_DIR)


```
<!-- ######################################################################## -->


*** 

# Abstract

This script assembles R object from data downloaded from 
[NCBI/Gene Expression Omnibus Database (GSE112679)](https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE112679).
The R objects will be assembled into an R dat package for
easy access.  The objects are constructed to parallel the
analyses of these data are reported in
Cai et al. (2019) [@Cai:2019aa]).  



# Set Analysis Parameters
 
```{r setAnalysisParameters, echo=T, cache=F}

 GSE_ID <- 'GSE112679'

 # extData
 ################################
 if(file.exists(file.path('../../extData'))) 
 EXT_DIR <- file.path('../../extData') else stop("Speficy EXT_DIR")

 # GSE_Data
 ###################################
 if(file.exists(file.path(EXT_DIR, GSE_ID)))
 GSE_DATA_DIR <- file.path(EXT_DIR,GSE_ID) else stop("Speficy GSE_DATA_DIR")

 # SampleDesc
 ###################################
 if(file.exists(file.path(GSE_DATA_DIR, paste0(GSE_ID,'_series_matrix.txt'))))
 SAMPLE_DESC_FILE <- file.path(GSE_DATA_DIR, paste0(GSE_ID,'_series_matrix.txt')) else 
 stop("Speficy SAMPLE_DESC_FILE")
 
```

```{r readSeqData.f, cache=F}
# Define utility function
readSeqData.f <- function(seqFile, Verbose=F){
 seqFile.frm <- fread(seqFile)
 names(seqFile.frm) <- c('GeneId','Chr', 'Start', 'End', 'Strand', 'Length', 'Count')

 # Reformat for ordering
 seqFile.frm$Chr <- 
  as.character(factor(seqFile.frm$Chr,
               levels=paste0('chr', c(1:22,'X','Y','M')),
               labels=paste0('chr', c(formatC(1:22,width=2,flag='0'),'X','Y','M'))))

 rownames(seqFile.frm) <-
 with(seqFile.frm, 
       paste(Chr, Strand, Start, End, GeneId, sep='~'))

 seqFile.frm <- seqFile.frm[,-(1:6),drop=F]
 if(Verbose) print(seqFile.frm[1:6,,drop=F])
 if(Verbose) print(dim(seqFile.frm))

 seqFile.frm}

```

# Load analysis dataset

## Get Sample Description Data

```{r readSampDesc,cache=T, cach.vars='sampDesc_frm', eval=T, echo=T, fig.height=6, fig.width=11}

# kelly's colors - https://i.kinja-img.com/gawker-media/image/upload/1015680494325093012.JPG
 # https://gist.github.com/ollieglass/f6ddd781eeae1d24e391265432297538
 #KellyColors.vec <-  see web site
 # REMOVED '#F2F3F4' in first entry
 col_vec <-  c('#222222', '#F3C300', '#875692', '#F38400', '#A1CAF1', 
              '#BE0032', '#C2B280', '#848482', '#008856', '#E68FAC', '#0067A5',
              '#F99379', '#604E97', '#F6A600', '#B3446C', '#DCD300', '#882D17',
              '#8DB600', '#654522', '#E25822', '#2B3D26')

 suppressPackageStartupMessages(require(GEOquery))

 GSEMatrix_obj <- getGEO(GSE_ID, GSEMatrix=T)
 show(GSEMatrix_obj)

 #DT::datatable(pData(phenoData(GSEMatrix_obj[[1]])))

 KEY_FIELDS <- grep(':ch1$', names(pData(phenoData(GSEMatrix_obj[[1]]))), value=T)

 sampType_vec <- sapply(
 strsplit(as.character(pData(phenoData(GSEMatrix_obj[[1]]))[,"title"]), 
 split='_'), function(X) X[1])

 sampNo_vec <- sapply(
 strsplit(as.character(pData(phenoData(GSEMatrix_obj[[1]]))[,"title"]), 
 split='_'), function(X) X[2])

 bioSamples_vec <- sapply(
 strsplit(as.character(pData(phenoData(GSEMatrix_obj[[1]]))[,"relation"]), 
 split='/'), function(X) rev(X)[1])

 SRA_vec <- sapply(
 strsplit(as.character(pData(phenoData(GSEMatrix_obj[[1]]))[,"relation.1"]), 
 split='='), function(X) rev(X)[1])

 fileName_vec <- sapply(
 strsplit(as.character(pData(phenoData(GSEMatrix_obj[[1]]))[,"supplementary_file_1"]), 
 split='/'), function(X) rev(X)[1])

 sampDesc_frm <- data.frame(
   geoAcc=pData(phenoData(GSEMatrix_obj[[1]]))[,"geo_accession"],
   title=pData(phenoData(GSEMatrix_obj[[1]]))[,"title"],
   sampType=sampType_vec,
   sampNo=sampNo_vec,
   bioSample=bioSamples_vec, 
   SRA=SRA_vec,
   fileName=fileName_vec,
   pData(phenoData(GSEMatrix_obj[[1]]))[, KEY_FIELDS])

 names(sampDesc_frm) <- 
 sub('bclc.stage.ch1', 'stage',
 sub('diagnosis.ch1', 'Dx',
 sub('tissue.subtype.ch1', 'tissueSubtype',
 sub('tissue.ch1', 'tissue',
 sub('training.validation.group.ch1', 'trainValGroup',
 names(sampDesc_frm))))))

 # Make sure fileName and geoAcc match
 fileNamegeoAcc.vec <- sapply(
 strsplit(as.character(sampDesc_frm$fileName), split='_'), '[',1)
 if(sum(fileNamegeoAcc.vec!= sampDesc_frm$geoAcc))
 stop("geoAcc/fileName Mismatch")

 str(sampDesc_frm)
 
 cat("geoAcc is unique - use as rownames:\n")
 with(sampDesc_frm, table(table(geoAcc, exclude=NULL)))
 rownames(sampDesc_frm) <- sampDesc_frm$geoAcc
 
 cat("SRA is unique:\n")
 with(sampDesc_frm, table(table(SRA, exclude=NULL)))
 
 cat("bioSample is unique:\n")
 with(sampDesc_frm, table(table(bioSample, exclude=NULL)))
 
 cat("title is unique:\n")
 with(sampDesc_frm, table(table(title, exclude=NULL)))

 cat("Some Samples Match bu sampNo:")
 with(sampDesc_frm, table(table(sampNo, exclude=NULL)))

 # NOTE: examination of the data indicate that sampNo cannot be used
 # to match Blood with TU or TI samples

DEPRICATED <- function() {
 NoSamp.tbl <- with(sampDesc_frm, table(sampNo, exclude=NULL))

 sampDesc_frm <- merge(
  data.frame(sampNo=names(nSamp.tbl), nSamp=as.vector(nSamp.tbl)),
  sampDesc_frm, by='sampNo', all.y=T)
}#DEPRICATED

 sampDesc_frm <- sampDesc_frm[with(sampDesc_frm,
  order(as.numeric(sampNo), title)),]


 # Shorten trainValGroup
 sampDesc_frm$trainValGroup <- 
 sub('Training', 'Train',
 sub('Validation', 'Val',
 sampDesc_frm$trainValGroup))

 # Shorten Dx
 sampDesc_frm$Dx <- 
 sub('Benign liver lesions', 'Benign',
 sub('Liver cirrhosis', 'Cirrhosis',
 sampDesc_frm$Dx))


 trainValGroupDX.tbl <-  
 with(sampDesc_frm, 
 table(Dx_tissue=paste0(Dx,'_',tissue), trainValGroup, exclude=NULL))

 trainValGroupDX.tbl

 barplot(trainValGroupDX.tbl, beside=T, legend=T, 
    col=col_vec[1:nrow(trainValGroupDX.tbl)])
 title("Sample Counts by Tissue Type")


 # For consistency with previous code, we will use Outcome as an alias to Dx,
 # and sampID as an alias to geoAcc
 sampDesc_frm$outcome <- sampDesc_frm$Dx
 sampDesc_frm$sampID <- sampDesc_frm$geoAcc

 cat("Cai et al. combine Beign+Healthy and Cirrhosis+HCC\n")
 cat("Create secondary outcome\n")
 sampDesc_frm$outcome2 <- with(sampDesc_frm, 
 ifelse(Dx %in% c("Benign", "Healthy"), 'BenignHealthy',
 ifelse(Dx %in% c("Cirrhosis", "CHB"), 'CirrhosisCHB', Dx)))

 with(sampDesc_frm, table(trainValGroup, outcome2, exclude=NULL))
 
 cat("Also want outcome3 == HCC or nonHCC\n")
 sampDesc_frm$outcome3 <- with(sampDesc_frm,
 ifelse(Dx == 'HCC', 'HCC', 'nonHCC'))

 with(sampDesc_frm, table(trainValGroup, outcome3, exclude=NULL))

 usethis::use_data(sampDesc_frm, overwrite=T)

```

## Sample Description Data Table

```{r DTsampDesc}

 DT::datatable(sampDesc_frm,  options=list(pageLength = 18))

```

# STOP HERE
```{r, echo=FALSE}
  knit_exit()
```

### ARCHIVAL CODE BELOW


## Get Count Data


NOTE: examination of the data indicate that sampNo cannot be used
to match Blood with TU or TI samples (Dx does not agree!).  It is also unclear whether 
sampNo can be used to match TU with TI.  Examination of the 
5hmC gene body profile similarities should tell us.  

There are too many samples in this dataset to store into a single count object.
We will create 4 dgel objects, TUTI, Train, Val_1, Val_2, 
corresponding to the matched tumor-tissue samples, the plasma train set and
the two plasma validation sets.  Note that there will be some overlap 
between TUTI and Train and Val_1.

<!-- IDEA
We will instead read each vector and store to the file system as a separate 
object.  Matrices will be assmbled as needed.  
-->


### TUTI

```{r  readTUTI, eval=T, cache=T, cache.vars='',message=F}
 ####,results='asis'}
 suppressPackageStartupMessages(require(edgeR))

 GSE.genebodyCountFiles.vec <- list.files(GSE_DATA_DIR, 'genebody')

 DD.TUTI.sampDesc.frm <- sampDesc_frm %>% dplyr::filter(SampType %in% c('TU', 'TI'))
 rownames(DD.TUTI.sampDesc.frm) <- DD.TUTI.sampDesc.frm$geoAcc

 ##############################################
 # Read seq data
 ##############################################
 TUTI.countFiles.vec <- DD.TUTI.sampDesc.frm$fileName
 names(TUTI.countFiles.vec) <- sapply(strsplit(TUTI.countFiles.vec, split='_'), '[',1)

 TUTI.countFiles.ndx <- match(TUTI.countFiles.vec, GSE.genebodyCountFiles.vec)

 if(sum(is.na(TUTI.countFiles.ndx))) {
   cat("Some count files are missing:\n")
   prnt(TUTI.countFiles.vec[is.na(TUTI.countFiles.ndx)])
 }

 TUTI.countFiles.vec <- intersect(TUTI.countFiles.vec, GSE.genebodyCountFiles.vec)
 names(TUTI.countFiles.vec) <- sapply(strsplit(TUTI.countFiles.vec, split='_'), '[',1)

 cat("\nFound", length(TUTI.countFiles.vec), 'count files\n')
  #print(TUTI.countFiles.vec)

if(length(TUTI.countFiles.vec)) {
  # Read first seqFile
  DD.TUTI.featureCount.frm <- readSeqData.f(file.path(GSE_DATA_DIR,TUTI.countFiles.vec[1]))

  # Read the rest 
  for(FF in TUTI.countFiles.vec[-1])
  DD.TUTI.featureCount.frm <- cbind(DD.TUTI.featureCount.frm, 
  readSeqData.f(file.path(GSE_DATA_DIR,FF), Verbose=F)[rownames(DD.TUTI.featureCount.frm),])

  colnames(DD.TUTI.featureCount.frm) <- names(TUTI.countFiles.vec)

  # Order columns according to DD.TUTI.sampDesc.frm order
  sampDesc.ndx <- match(DD.TUTI.sampDesc.frm$geoAcc, colnames(DD.TUTI.featureCount.frm))

  # Sufficient samples
  if(sum(is.na(sampDesc.ndx))) 
   {warning("geoAcc in DD.TUTI.sampDesc.frm not in DD.TUTI.featureCount.frm:\n")
    missing.ndx <- which(is.na(sampDesc.ndx))
    print(kable(DD.TUTI.sampDesc.frm[missing.ndx,]))
  }

  # Necessary samples - STOP IF NOT IN DD.TUTI.sampDesc.frm
  if(length(setdiff(colnames(DD.TUTI.featureCount.frm), DD.TUTI.sampDesc.frm$geoAcc)))
   {cat("seqIDs in DD.TUTI.featureCount.frm with no record in DD.TUTI.sampDesc.frm:\n")
    print(DD.TUTI.sampDesc.frm$geoAcc[is.na(sampDesc.ndx)])
    #stop("geoAcc/Seq File Name mismatch")
    warning("geoAcc/Seq File Name mismatch")
    knit_exit()
 }


 # Not sure this is necessary.
 #DD.TUTI.featureCount.frm <- DD.TUTI.featureCount.frm[, setdiff(sampDesc.ndx, NA)]
 #dim(DD.TUTI.featureCount.frm)

 #print(kable(DD.TUTI.featureCount.frm[1:5, 1:2]))

 # Save as dgel
 #saveObj(paste0(DD,".TUTI.featureCount.frm"), "DD.TUTI.featureCount.frm")
  
 Genes.frm <-
 data.frame(Symbol=sapply(strsplit(rownames(DD.TUTI.featureCount.frm), split='~'), function(x) rev(x)[1]),
             Chr=sapply(strsplit(rownames(DD.TUTI.featureCount.frm), split='~'), '[', 1),
             Strand=sapply(strsplit(rownames(DD.TUTI.featureCount.frm), split='~'), '[', 2),
             Start=sapply(strsplit(rownames(DD.TUTI.featureCount.frm), split='~'), '[', 3),
             Stop=sapply(strsplit(rownames(DD.TUTI.featureCount.frm), split='~'), '[', 4),
             Length=sapply(strsplit(rownames(DD.TUTI.featureCount.frm), split='~'),
       function(x) as.numeric(x[4]) - as.numeric(x[3]) +1))
 rownames(Genes.frm) <- rownames(DD.TUTI.featureCount.frm)

 rownames(DD.TUTI.sampDesc.frm) <- DD.TUTI.sampDesc.frm$geoAcc

 print(with(Genes.frm, table(Chr, exclude=NULL)))

 DD.TUTI.dgel <- DGEList(
 counts=DD.TUTI.featureCount.frm,
 samples=DD.TUTI.sampDesc.frm[colnames(DD.TUTI.featureCount.frm),],
 genes=Genes.frm[rownames(DD.TUTI.featureCount.frm),])

 DD.TUTI.dgel$samples$totCovm <-  colSums(DD.TUTI.dgel$counts)/1e6

 saveObj(paste0(DD, ".TUTI.dgel"), "DD.TUTI.dgel")
    
 }# if(length(TUTI.countFiles.vec)) {
```

### Train

```{r readSeqData2.f, cache=F}
readSeqData2.f <- function(seqFile, Verbose=F){
 seqFile.frm <- fread(seqFile)
 names(seqFile.frm) <- c('GeneId','Count')

 rownames(seqFile.frm) <- seqFile.frm$GeneId

 seqFile.frm <- seqFile.frm[,-1,drop=F]
 if(Verbose) print(seqFile.frm[1:6,,drop=F])
 if(Verbose) print(dim(seqFile.frm))

 seqFile.frm}

```

```{r  readTrain, eval=T, cache=T, cache.vars='',message=F}
 ####,results='asis'}
 suppressPackageStartupMessages(require(edgeR))

 GSE.genebodyCountFiles.vec <- list.files(GSE_DATA_DIR, 'genebody')

 DD.Train.sampDesc.frm <- sampDesc_frm %>% dplyr::filter(trainValGroup %in% c('Train'))
 rownames(DD.Train.sampDesc.frm) <- DD.Train.sampDesc.frm$geoAcc

 ##############################################
 # Read seq data
 ##############################################
 Train.countFiles.vec <- DD.Train.sampDesc.frm$fileName
 names(Train.countFiles.vec) <- sapply(strsplit(Train.countFiles.vec, split='_'), '[',1)

 Train.countFiles.ndx <- match(Train.countFiles.vec, GSE.genebodyCountFiles.vec)

 if(sum(is.na(Train.countFiles.ndx))) {
   cat("Some count files are missing:\n")
   prnt(Train.countFiles.vec[is.na(Train.countFiles.ndx)])
 }

 Train.countFiles.vec <- intersect(Train.countFiles.vec, GSE.genebodyCountFiles.vec)
 names(Train.countFiles.vec) <- sapply(strsplit(Train.countFiles.vec, split='_'), '[',1)

 cat("\nFound", length(Train.countFiles.vec), 'count files\n')
  #print(Train.countFiles.vec)

if(length(Train.countFiles.vec)) {
  # Read first seqFile
  DD.Train.featureCount.frm <- readSeqData2.f(file.path(GSE_DATA_DIR,Train.countFiles.vec[1]))

  # Read the rest 
  for(FF in Train.countFiles.vec[-1])
  DD.Train.featureCount.frm <- cbind(DD.Train.featureCount.frm, 
  readSeqData2.f(file.path(GSE_DATA_DIR,FF), Verbose=F)[rownames(DD.Train.featureCount.frm),])

  colnames(DD.Train.featureCount.frm) <- names(Train.countFiles.vec)

  # Order columns according to DD.Train.sampDesc.frm order
  sampDesc.ndx <- match(DD.Train.sampDesc.frm$geoAcc, colnames(DD.Train.featureCount.frm))

  # Sufficient samples
  if(sum(is.na(sampDesc.ndx))) 
   {warning("geoAcc in DD.Train.sampDesc.frm not in DD.Train.featureCount.frm:\n")
    missing.ndx <- which(is.na(sampDesc.ndx))
    print(kable(DD.Train.sampDesc.frm[missing.ndx,]))
  }

  # Necessary samples - STOP IF NOT IN DD.Train.sampDesc.frm
  if(length(setdiff(colnames(DD.Train.featureCount.frm), DD.Train.sampDesc.frm$geoAcc)))
   {cat("seqIDs in DD.Train.featureCount.frm with no record in DD.Train.sampDesc.frm:\n")
    print(DD.Train.sampDesc.frm$geoAcc[is.na(sampDesc.ndx)])
    #stop("geoAcc/Seq File Name mismatch")
    warning("geoAcc/Seq File Name mismatch")
    knit_exit()
 }


 # Not sure this is necessary.
 #DD.Train.featureCount.frm <- DD.Train.featureCount.frm[, setdiff(sampDesc.ndx, NA)]
 #dim(DD.Train.featureCount.frm)

 #print(kable(DD.Train.featureCount.frm[1:5, 1:2]))

 # Save as dgel
 #saveObj(paste0(DD,'.', ".Train.featureCount.frm"), "DD.Train.featureCount.frm")
  
 # Get gene info from DD.TUTI.dgel
 loadObj(paste0(DD,".TUTI.dgel"), "DD.TUTI.dgel")
 
 genes.ndx <- match(rownames(DD.Train.featureCount.frm), 
  sapply(strsplit(rownames(DD.TUTI.dgel$genes), split='~'), function(X) rev(X)[1]))
 if(sum(is.na(genes.ndx))) stop("Mismatched Genes")
 if(sum(duplicated(genes.ndx))) stop("Duplicated Genes")

 Genes.frm <- DD.TUTI.dgel$genes[genes.ndx,]
 rownames(Genes.frm) <- rownames(DD.Train.featureCount.frm)

 rownames(DD.Train.sampDesc.frm) <- DD.Train.sampDesc.frm$geoAcc

 DD.Train.dgel <- DGEList(
 counts=DD.Train.featureCount.frm,
 samples=DD.Train.sampDesc.frm[colnames(DD.Train.featureCount.frm),],
 genes=Genes.frm[rownames(DD.Train.featureCount.frm),])

 DD.Train.dgel$samples$totCovm <-  colSums(DD.Train.dgel$counts)/1e6

 saveObj(paste0(DD, ".Train.dgel"), "DD.Train.dgel")
    
 }# if(length(Train.countFiles.vec)) {

```

### Val_1

```{r  readVal_1, eval=T, cache=T, cache.vars='',message=F}
 ####,results='asis'}
 suppressPackageStartupMessages(require(edgeR))

 GSE.genebodyCountFiles.vec <- list.files(GSE_DATA_DIR, 'genebody')

 DD.Val_1.sampDesc.frm <- sampDesc_frm %>% dplyr::filter(trainValGroup %in% c('Val-1'))
 rownames(DD.Val_1.sampDesc.frm) <- DD.Val_1.sampDesc.frm$geoAcc

 ##############################################
 # Read seq data
 ##############################################
 Val_1.countFiles.vec <- DD.Val_1.sampDesc.frm$fileName
 names(Val_1.countFiles.vec) <- sapply(strsplit(Val_1.countFiles.vec, split='_'), '[',1)

 Val_1.countFiles.ndx <- match(Val_1.countFiles.vec, GSE.genebodyCountFiles.vec)

 if(sum(is.na(Val_1.countFiles.ndx))) {
   cat("Some count files are missing:\n")
   prnt(Val_1.countFiles.vec[is.na(Val_1.countFiles.ndx)])
 }

 Val_1.countFiles.vec <- intersect(Val_1.countFiles.vec, GSE.genebodyCountFiles.vec)
 names(Val_1.countFiles.vec) <- sapply(strsplit(Val_1.countFiles.vec, split='_'), '[',1)

 cat("\nFound", length(Val_1.countFiles.vec), 'count files\n')
  #print(Val_1.countFiles.vec)

if(length(Val_1.countFiles.vec)) {
  # Read first seqFile
  DD.Val_1.featureCount.frm <- readSeqData2.f(file.path(GSE_DATA_DIR,Val_1.countFiles.vec[1]))

  # Read the rest 
  for(FF in Val_1.countFiles.vec[-1])
  DD.Val_1.featureCount.frm <- cbind(DD.Val_1.featureCount.frm, 
  readSeqData2.f(file.path(GSE_DATA_DIR,FF), Verbose=F)[rownames(DD.Val_1.featureCount.frm),])

  colnames(DD.Val_1.featureCount.frm) <- names(Val_1.countFiles.vec)

  # Order columns according to DD.Val_1.sampDesc.frm order
  sampDesc.ndx <- match(DD.Val_1.sampDesc.frm$geoAcc, colnames(DD.Val_1.featureCount.frm))

  # Sufficient samples
  if(sum(is.na(sampDesc.ndx))) 
   {warning("geoAcc in DD.Val_1.sampDesc.frm not in DD.Val_1.featureCount.frm:\n")
    missing.ndx <- which(is.na(sampDesc.ndx))
    print(kable(DD.Val_1.sampDesc.frm[missing.ndx,]))
  }

  # Necessary samples - STOP IF NOT IN DD.Val_1.sampDesc.frm
  if(length(setdiff(colnames(DD.Val_1.featureCount.frm), DD.Val_1.sampDesc.frm$geoAcc)))
   {cat("seqIDs in DD.Val_1.featureCount.frm with no record in DD.Val_1.sampDesc.frm:\n")
    print(DD.Val_1.sampDesc.frm$geoAcc[is.na(sampDesc.ndx)])
    #stop("geoAcc/Seq File Name mismatch")
    warning("geoAcc/Seq File Name mismatch")
    knit_exit()
 }


 # Not sure this is necessary.
 #DD.Val_1.featureCount.frm <- DD.Val_1.featureCount.frm[, setdiff(sampDesc.ndx, NA)]
 #dim(DD.Val_1.featureCount.frm)

 #print(kable(DD.Val_1.featureCount.frm[1:5, 1:2]))

 # Save as dgel
 #saveObj(paste0(DD, ".Val_1.featureCount.frm"), "DD.Val_1.featureCount.frm")
  
 # Get gene info from DD.TUTI.dgel
 loadObj(paste0(DD,".TUTI.dgel"), "DD.TUTI.dgel")
 
 genes.ndx <- match(rownames(DD.Val_1.featureCount.frm), 
  sapply(strsplit(rownames(DD.TUTI.dgel$genes), split='~'), function(X) rev(X)[1]))
 if(sum(is.na(genes.ndx))) stop("Mismatched Genes")
 if(sum(duplicated(genes.ndx))) stop("Duplicated Genes")

 Genes.frm <- DD.TUTI.dgel$genes[genes.ndx,]
 rownames(Genes.frm) <- rownames(DD.Val_1.featureCount.frm)

 rownames(DD.Val_1.sampDesc.frm) <- DD.Val_1.sampDesc.frm$geoAcc

 DD.Val_1.dgel <- DGEList(
 counts=DD.Val_1.featureCount.frm,
 samples=DD.Val_1.sampDesc.frm[colnames(DD.Val_1.featureCount.frm),],
 genes=Genes.frm[rownames(DD.Val_1.featureCount.frm),])

 DD.Val_1.dgel$samples$totCovm <-  colSums(DD.Val_1.dgel$counts)/1e6

 saveObj(paste0(DD, ".Val_1.dgel"), "DD.Val_1.dgel")
    
 }# if(length(Val_1.countFiles.vec)) {
```

### Val_2

```{r  readVal_2, eval=T, cache=T, cache.vars='',message=F}
 ####,results='asis'}
 suppressPackageStartupMessages(require(edgeR))

 GSE.genebodyCountFiles.vec <- list.files(GSE_DATA_DIR, 'genebody')

 DD.Val_2.sampDesc.frm <- sampDesc_frm %>% dplyr::filter(trainValGroup %in% c('Val-2'))
 rownames(DD.Val_2.sampDesc.frm) <- DD.Val_2.sampDesc.frm$geoAcc

 ##############################################
 # Read seq data
 ##############################################
 Val_2.countFiles.vec <- DD.Val_2.sampDesc.frm$fileName
 names(Val_2.countFiles.vec) <- sapply(strsplit(Val_2.countFiles.vec, split='_'), '[',1)

 Val_2.countFiles.ndx <- match(Val_2.countFiles.vec, GSE.genebodyCountFiles.vec)

 if(sum(is.na(Val_2.countFiles.ndx))) {
   cat("Some count files are missing:\n")
   prnt(Val_2.countFiles.vec[is.na(Val_2.countFiles.ndx)])
 }

 Val_2.countFiles.vec <- intersect(Val_2.countFiles.vec, GSE.genebodyCountFiles.vec)
 names(Val_2.countFiles.vec) <- sapply(strsplit(Val_2.countFiles.vec, split='_'), '[',1)

 cat("\nFound", length(Val_2.countFiles.vec), 'count files\n')
  #print(Val_2.countFiles.vec)

if(length(Val_2.countFiles.vec)) {
  # Read first seqFile
  DD.Val_2.featureCount.frm <- readSeqData2.f(file.path(GSE_DATA_DIR,Val_2.countFiles.vec[1]))

  # Read the rest 
  for(FF in Val_2.countFiles.vec[-1])
  DD.Val_2.featureCount.frm <- cbind(DD.Val_2.featureCount.frm, 
  readSeqData2.f(file.path(GSE_DATA_DIR,FF), Verbose=F)[rownames(DD.Val_2.featureCount.frm),])

  colnames(DD.Val_2.featureCount.frm) <- names(Val_2.countFiles.vec)

  # Order columns according to DD.Val_2.sampDesc.frm order
  sampDesc.ndx <- match(DD.Val_2.sampDesc.frm$geoAcc, colnames(DD.Val_2.featureCount.frm))

  # Sufficient samples
  if(sum(is.na(sampDesc.ndx))) 
   {warning("geoAcc in DD.Val_2.sampDesc.frm not in DD.Val_2.featureCount.frm:\n")
    missing.ndx <- which(is.na(sampDesc.ndx))
    print(kable(DD.Val_2.sampDesc.frm[missing.ndx,]))
  }

  # Necessary samples - STOP IF NOT IN DD.Val_2.sampDesc.frm
  if(length(setdiff(colnames(DD.Val_2.featureCount.frm), DD.Val_2.sampDesc.frm$geoAcc)))
   {cat("seqIDs in DD.Val_2.featureCount.frm with no record in DD.Val_2.sampDesc.frm:\n")
    print(DD.Val_2.sampDesc.frm$geoAcc[is.na(sampDesc.ndx)])
    #stop("geoAcc/Seq File Name mismatch")
    warning("geoAcc/Seq File Name mismatch")
    knit_exit()
 }


 # Not sure this is necessary.
 #DD.Val_2.featureCount.frm <- DD.Val_2.featureCount.frm[, setdiff(sampDesc.ndx, NA)]
 #dim(DD.Val_2.featureCount.frm)

 #print(kable(DD.Val_2.featureCount.frm[1:5, 1:2]))

 # Save as dgel
 #saveObj(paste0(DD, ".Val_2.featureCount.frm"), "DD.Val_2.featureCount.frm")
  
 # Get gene info from DD.TUTI.dgel
 loadObj(paste0(DD,".TUTI.dgel"), "DD.TUTI.dgel")
 
 genes.ndx <- match(rownames(DD.Val_2.featureCount.frm), 
  sapply(strsplit(rownames(DD.TUTI.dgel$genes), split='~'), function(X) rev(X)[1]))
 if(sum(is.na(genes.ndx))) stop("Mismatched Genes")
 if(sum(duplicated(genes.ndx))) stop("Duplicated Genes")

 Genes.frm <- DD.TUTI.dgel$genes[genes.ndx,]
 rownames(Genes.frm) <- rownames(DD.Val_2.featureCount.frm)

 rownames(DD.Val_2.sampDesc.frm) <- DD.Val_2.sampDesc.frm$geoAcc

 DD.Val_2.dgel <- DGEList(
 counts=DD.Val_2.featureCount.frm,
 samples=DD.Val_2.sampDesc.frm[colnames(DD.Val_2.featureCount.frm),],
 genes=Genes.frm[rownames(DD.Val_2.featureCount.frm),])

 DD.Val_2.dgel$samples$totCovm <-  colSums(DD.Val_2.dgel$counts)/1e6

 saveObj(paste0(DD, ".Val_2.dgel"), "DD.Val_2.dgel")
    
 }# if(length(Val_2.countFiles.vec)) {
```


<!-- SKIP THIS
- [saveObj](`r file.path(help_DIR, 'saveObj.r')`) and
[loadObj](`r file.path(help_DIR, 'loadObj.r')`) are used 
to move objects between the file system and the workspace.
- [getKappa](`r file.path(help_DIR, 'getKappa.r')`) computes Cohen's kappa 
which we use as a measure of agreement between clutering results and labels.
- [mtext2by2Tbl](`r file.path(help_DIR, 'mtext2by2Tbl.r')`) prints a 2 by 2 table below a plot.

-->

```{r, echo=FALSE}
 sessionInfo()
```


```{r, echo=FALSE}
  knit_exit()
```

### ARCHIVAL CODE BELOW
<!-- ######################################################################## -->


<!-- To run
# nohup Rscript -e "knitr::knit2html('rdGSEData.Rmd')" > rdGSEData.log  &

# Or
# nohup Rscript -e "rmarkdown::render('rdGSEData.Rmd')" > rdGSEData.log  &

-->

